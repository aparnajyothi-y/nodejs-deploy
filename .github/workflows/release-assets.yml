name: Node Redirect Repro
on: workflow_dispatch

jobs:
  redirect-test:
    runs-on: ubuntu-latest
    env:
      ACTIONS_STEP_DEBUG: true
      ACTIONS_RUNNER_DEBUG: true

    steps:
      - uses: actions/checkout@v4

      - name: Generate cache-bust token
        id: token
        run: echo "token=$(date +%s)" >> $GITHUB_OUTPUT

      # 1) Force "no manifest" mode -> skips node-versions JSON lookup
      - name: Setup Node (force direct fetch / CDN redirect)
        uses: actions/setup-node@v4
        with:
          node-version: "20.17.0"
          check-latest: true
          cache: "npm"
        env:
          # NodeTool respects these fetch parameters internally
          NODETOOL_FORCE_REDOWNLOAD: "true"
          NODETOOL_CACHEBUST: ${{ steps.token.outputs.token }}

      - name: Verify redirect trigger
        run: |
          node -v
          which node
          echo "Completed. Check logs above for 302 redirect to release-assets.githubusercontent.com"
